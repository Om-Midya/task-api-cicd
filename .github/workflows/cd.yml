# =============================================================================
# CD Pipeline - Continuous Deployment to Google Kubernetes Engine (GKE)
# =============================================================================
# This workflow deploys the application to GKE after CI passes.
#
# STAGES:
# 1. Authenticate with Google Cloud
# 2. Configure kubectl for GKE
# 3. Update deployment with new image
# 4. Apply Kubernetes manifests
# 5. Wait for rollout and verify
# 6. Run DAST scan
# =============================================================================

name: CD Pipeline

# =============================================================================
# TRIGGERS
# =============================================================================
on:
  # Trigger after CI pipeline completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
      - master

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/task-api
  GKE_CLUSTER: task-api-cluster-devops
  GKE_REGION: us-central1
  GCP_PROJECT_ID: striped-buckeye-484911-r7

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # JOB: Deploy to GKE
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    # Only run if CI was successful (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # -----------------------------------------------------------------------
      # STAGE 1: Checkout code
      # Purpose: Get the Kubernetes manifests
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # STAGE 2: Authenticate with Google Cloud
      # Purpose: Allow GitHub Actions to access GKE
      # -----------------------------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}

      # -----------------------------------------------------------------------
      # STAGE 3: Setup Google Cloud SDK
      # Purpose: Install gcloud CLI
      # -----------------------------------------------------------------------
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # -----------------------------------------------------------------------
      # STAGE 4: Install GKE auth plugin and configure kubectl
      # Purpose: Connect kubectl to GKE cluster
      # -----------------------------------------------------------------------
      - name: Install GKE auth plugin
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      # -----------------------------------------------------------------------
      # STAGE 5: Update deployment manifest with image tag
      # Purpose: Use correct Docker image
      # -----------------------------------------------------------------------
      - name: Set image tag
        id: image
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image: ${{ env.DOCKER_IMAGE }}:$TAG"

      # -----------------------------------------------------------------------
      # STAGE 6: Deploy to GKE
      # Purpose: Apply Kubernetes manifests
      # -----------------------------------------------------------------------
      - name: Deploy to GKE
        run: |
          echo "Deploying to GKE cluster: ${{ env.GKE_CLUSTER }}"

          # Apply manifests
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

          # Force rollout with new image
          kubectl set image deployment/task-api \
            task-api=${{ env.DOCKER_IMAGE }}:${{ steps.image.outputs.tag }}

      # -----------------------------------------------------------------------
      # STAGE 7: Wait for rollout to complete
      # Purpose: Ensure deployment is successful
      # -----------------------------------------------------------------------
      - name: Wait for rollout
        run: |
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/task-api --timeout=120s

      # -----------------------------------------------------------------------
      # STAGE 8: Verify deployment
      # Purpose: Check pods and service are running
      # -----------------------------------------------------------------------
      - name: Verify deployment
        run: |
          echo "============================================="
          echo "DEPLOYMENT STATUS"
          echo "============================================="
          echo ""
          echo "Pods:"
          kubectl get pods -l app=task-api
          echo ""
          echo "Service:"
          kubectl get svc task-api-service
          echo ""
          EXTERNAL_IP=$(kubectl get svc task-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "External IP: $EXTERNAL_IP"
          echo ""
          echo "============================================="

      # -----------------------------------------------------------------------
      # STAGE 9: Health check
      # Purpose: Verify application is responding
      # -----------------------------------------------------------------------
      - name: Health check
        run: |
          EXTERNAL_IP=$(kubectl get svc task-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Testing health endpoint: http://$EXTERNAL_IP/health"

          # Wait for external IP and test
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://$EXTERNAL_IP/health 2>/dev/null || echo "000")
            if [ "$response" == "200" ]; then
              echo "âœ… Health check passed!"
              curl -s http://$EXTERNAL_IP/health
              exit 0
            fi
            echo "Attempt $i: HTTP $response - waiting..."
            sleep 10
          done

          echo "âŒ Health check failed after 10 attempts"
          exit 1

      # -----------------------------------------------------------------------
      # STAGE 10: Output deployment URL
      # Purpose: Show where the application is accessible
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          EXTERNAL_IP=$(kubectl get svc task-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "============================================="
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "============================================="
          echo ""
          echo "Application URL: http://$EXTERNAL_IP"
          echo "Health check:    http://$EXTERNAL_IP/health"
          echo "API endpoint:    http://$EXTERNAL_IP/api/tasks"
          echo ""
          echo "============================================="

  # ---------------------------------------------------------------------------
  # JOB: DAST Scan (Dynamic Application Security Testing)
  # ---------------------------------------------------------------------------
  dast-scan:
    name: DAST Security Scan
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}

      - name: Install GKE auth plugin
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Get application URL
        id: url
        run: |
          EXTERNAL_IP=$(kubectl get svc task-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "url=http://$EXTERNAL_IP" >> $GITHUB_OUTPUT
          echo "Application URL: http://$EXTERNAL_IP"

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ steps.url.outputs.url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true  # Don't fail pipeline on findings

      - name: DAST Scan Summary
        run: |
          echo "============================================="
          echo "DAST SCAN COMPLETED"
          echo "============================================="
          echo ""
          echo "OWASP ZAP scanned: ${{ steps.url.outputs.url }}"
          echo ""
          echo "Check the 'Security' tab in your repository"
          echo "for detailed findings."
          echo "============================================="
